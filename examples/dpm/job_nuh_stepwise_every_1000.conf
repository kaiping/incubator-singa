name: "dpm"
# To scan the training data 1 time, training data: 9476 samples
train_steps:9476 #1 times
# To scan the test data once, test data: 1053 samples
test_steps:1053
test_freq:1000
disp_freq:1000
gpu: 0

train_one_batch {
  alg: kBPTT
}

updater{
  type: kSGD
  learning_rate {
    type: kFixedStep
    fixedstep_conf:{
      step:0
      step:1000
      step:2000
      step:3000
      step:4000
      step:5000
      step:6000
      step:7000
      step:8000
      step:9000
      step_lr:0.001
      step_lr:0.0001
      step_lr:0.00001
      step_lr:0.000001
      step_lr:0.0000001
      step_lr:0.00000001
      step_lr:0.000000001
      step_lr:0.0000000001
      step_lr:0.00000000001
      step_lr:0.000000000001
    }
  }
}

neuralnet {

unroll_len:50 

layer {
  name: "data"
  user_type: "kData"
  unroll_len: 1
  [data_conf] {
    backend: "kvfile"
    path: "examples/dpm/train_input_data.bin"
    label_path: "examples/dpm/train_label_data.bin"
    batchsize: 1
    unroll_len: 50
    feature_len: 6037
  }
  include: kTrain
}

layer {
  name: "data"
  user_type: "kData"
  unroll_len: 1
  [data_conf] {
    backend: "kvfile"
    path: "examples/dpm/test_input_data.bin"
    label_path: "examples/dpm/test_label_data.bin"
    batchsize: 1
    unroll_len: 50
    feature_len: 6037
  }
  include: kTest
}

layer {
  name: "unroll"
  user_type: "kUnroll"
  srclayers: "data"
  unroll_conn_type: kUnrollOneToAll
}

  layer {
    name: "gru"
    type: kGRU
    srclayers: "unroll"
    gru_conf {
      dim_hidden: 1024
    }
    param {
      name: "z_hx"
      init {
        type: kUniform
        low: -0.08
        high: 0.08
      }
    }
    param {
      name: "r_hx"
      init {
        type: kUniform
        low: -0.08
        high: 0.08
      }
    }
    param {
      name: "c_hx"
      init {
        type: kUniform
        low: -0.08
        high: 0.08
      }
    }
    param {
      name: "z_hh"
      init {
        type: kUniform
        low: -0.08
        high: 0.08
      }
    }
    param {
      name: "r_hh"
      init {
        type: kUniform
        low: -0.08
        high: 0.08
      }
    }
    param {
      name: "c_hh"
      init {
        type: kUniform
        low: -0.08
        high: 0.08
      }
    }
    param {
      name: "z_b"
      init {
        type: kUniform
        low: -0.08
        high: 0.08
      }
    }
    param {
      name: "r_b"
      init {
        type: kUniform
        low: -0.08
        high: 0.08
      }
    }
    param {
      name: "c_b"
      init {
        type: kUniform
        low: -0.08
        high: 0.08
      }
    }
  }

  layer {
    name: "label"
    user_type: "kDPMLabel"
    srclayers: "data"
    unroll_len: 1
  }

  layer {
    name: "time"
    user_type: "kDPMTime"
    srclayers: "data"
    unroll_len: 1
  }


  layer {
    name: "combination"
    user_type: "kCombination"
    srclayers: "gru"
    srclayers: "time"
    unroll_len: 1
    unroll_conn_type: kUnrollFirstToLast
    [combination_conf] {
      num_output:20
    }
    param {
      name: "whc"
      init {
        type: kUniform
        low: -0.05
        high: 0.05
      }
    }
    param {
      name: "alpha"
      init {
        type: kUniform
        low: -0.05
        high: 0.05
      }
    }
    param {
      name: "bhc"
      init {
        type: kUniform
        low: -0.05
        high: 0.05
      }
    }
  }

  layer {
    name: "tanh"
    type: kSTanh
    srclayers: "combination"
    unroll_len: 1
  }

  layer {
    name: "fc"
    type: kInnerProduct
    srclayers: "tanh"
    unroll_len: 1
    innerproduct_conf {
      num_output:1
    }
    param {
      name: "beta"
      init {
        type: kUniform
        low: -0.05
        high: 0.05
      }
    }
    param {
      name: "b"
      init {
        type: kUniform
        low: -0.05
        high: 0.05
      }
    }
  }


  layer {
    name: "loss"
    type: kEuclideanLoss
    srclayers: "fc"
    srclayers: "label"
    unroll_len: 1
  }

}

cluster {
  workspace: "examples/dpm/"
}
